### Broadcaster — Telegram-интерфейс для массовых рассылок и общения через юзерботов

Этот проект объединяет интерфейс‑бота (Aiogram v3) для администраторов и несколько Telegram‑юзерботов (Pyrogram), которые:
- принимают личные сообщения от пользователей и пересылают их администраторам;
- позволяют администраторам отвечать пользователям прямо из интерфейс‑бота;
- выполняют периодические рассылки медиа/текста по спискам чатов через планировщик (APScheduler) с хранением настроек в PostgreSQL.


### Стек
- **Aiogram v3**: интерфейс‑бот, FSM, DI
- **Pyrogram**: юзерботы и отправка сообщений/медиагрупп
- **APScheduler**: периодические задания, SQLAlchemyJobStore
- **SQLAlchemy**: ORM‑модели и репозитории
- **PostgreSQL**: база данных (как для приложения, так и для APScheduler)
- **environs**: загрузка конфигурации из `.env`
- **pytz**: таймзона планировщика (UTC)


### Архитектура (высокоуровнево)
```mermaid
graph TD
  A[Администраторы] <--> B[Интерфейс-бот (Aiogram)]
  B -- команды / FSM --> C[Сервисы и репозитории]
  C <--> D[(PostgreSQL)]
  B <-- планирование --> E[APScheduler]
  E --> F[Задачи рассылки]
  F --> G[Юзерботы (Pyrogram)]
  G --> H[Чаты/пользователи в Telegram]
  G --> B
  B --> A
```


### Основной функционал
- **Маршрутизация входящих сообщений**: каждый юзербот слушает личные сообщения и пересылает их интерфейс‑боту. Интерфейс‑бот доставляет их администраторам с атрибутами отправителя и кодом для ответного роутинга.
- **Ответ админа пользователю**: администратор отвечает «реплаем» на сообщение от интерфейс‑бота — ответ уходит нужному пользователю через соответствующего юзербота.
- **Рассылки**:
  - создание рассылки: выбор пакета, юзербота, списка чатов и периода (секунды/часы/дни);
  - хранение настроек в `mailings` (PostgreSQL), контента — в папке `msg/<имя_пакета>` (текст и медиа);
  - отправка медиагруппы с подписью (подпись — текст из `text.txt`, прикрепляется к первому элементу медиагруппы) либо просто текста, если медиа нет;
  - «догоняющая» логика при пропущенных отправках: если прошло больше периода от `last_mail_date`, первая отправка делается немедленно, далее — по интервалу.
- **Редактирование рассылок**: обновление текста, добавление/удаление фото, изменение периода с пересборкой расписания.
- **Отладка** (при включённом `DEBUG_FLAG`): быстрый запуск тестовой рассылки из меню.
- **Прогрев peer‑кэша** Pyrogram: при старте резолвятся диалоги и чаты рассылок, чтобы минимизировать ошибки «Peer id invalid».


### Команды интерфейс‑бота
- `/start` — приветствие и проверка прав (доступно только администраторам из конфига).
- `/create_mailing` — мастер создания рассылки (FSM):
  1) имя пакета → 2) выбор юзербота → 3) список chat_id → 4) текст/медиа → 5) период;
  по завершении первая отправка планируется немедленно.
- `/edit_mailing` — выбор рассылки и её редактирование (текст, фото, период).
- `/debug_mail` — меню отладки для тестовых отправок (показывается, если `DEBUG_FLAG=true`).
- `/done` — служебная команда для завершения добавления фото в режиме редактирования.


### Структура проекта (ключевые узлы)
```
broadcaster/
  bot_interface/
    src/
      main.py                # Точка входа приложения
      core/
        config.py            # Модель и загрузка конфига из .env
        dependencies.py      # Инициализация БД, DI сервисов и конфигурации
        scheduler.py         # Планировщик и логика отправки рассылок
        userbot.py           # Обёртка Pyrogram-клиента
        states.py            # FSM-состояния для рассылок
      controllers/
        admin_commands.py    # Команды админа (создание/редактирование рассылок, ответы)
        debug_commands.py    # Отладочные команды (тестовые рассылки)
        states.py            # Доп. состояние для ответов
      models/
        db/postgres_conn.py  # Подключение к БД (SQLAlchemy)
        models/              # ORM-модели: User, AdminUser, Mailing, Base
        repositories/        # Репозитории (CRUD и спец-методы)
      views/
        services.py          # Сервисы-обёртки над репозиториями
        keyboards/           # Инлайн-клавиатуры (в т.ч. для отладки)
      utils/                 # Вспомогательные функции
      msg/                   # Папки с пакетами рассылок: текст + медиа
```


### Модели БД (основные)
- `users(id, user_name, real_name, phone_number)`
- `admin_users(id, name)`
- `mailings(id, name, userbot_name, chat_ids[bigint], period, is_active, last_mail_date, created_at)`

Рассылки планируются и исполняются на стороне APScheduler; факт отправки фиксируется обновлением `last_mail_date`.


### Конфигурация (.env)
Файл конфигурации ожидается в корне проекта. По умолчанию приложение загружает `.env copy` (см. `src/core/dependencies.py`). Рекомендуется переименовать его в `.env` или скорректировать путь в коде.

Пример содержимого:
```dotenv
# PostgreSQL (используется также APScheduler)
DB_HOST=localhost
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_DB=broadcaster
DB_PORT=5432
DB_URL=postgresql+psycopg2://postgres:postgres@localhost:5432/broadcaster

# Интерфейс-бот (Aiogram)
INTERFACE_BOT_TOKEN=123456:ABCDEF_your_token
INTERFACE_BOT_USERNAME=@my_interface_bot

# Администраторы (список объектов JSON)
ADMIN_USERS=[{"id":123456789, "name":"Admin"}]
ROOT=[]

# Юзерботы (список объектов JSON)
USERBOT_ACCOUNT=[
  {"name":"Dima","api_id":11111,"api_hash":"your_api_hash","number":"+380000000001"},
  {"name":"Victoria","api_id":22222,"api_hash":"your_api_hash","number":"+380000000002"}
]

# Отладка
DEBUG_FLAG=true
```

Замечания:
- Pyrogram создаёт файлы сессий по имени аккаунта (`<name>.session`). В репозитории уже есть примеры: `Dima.session`, `Victoria.session`, т.п. Размещайте их рядом с запускаемым скриптом, чтобы Pyrogram их увидел.
- Папка `msg/` должна находиться в текущей рабочей директории процесса. Если запускаете скрипт из `broadcaster/bot_interface/src`, используйте встроенную `src/msg`. Если запускаете из корня репозитория — используйте `broadcaster/msg` (или скорректируйте пути в коде).


### Установка и запуск (Windows, PowerShell)
```powershell
cd D:\0_filesys\3_Library\0_Project\Rabbit Hole\broadcaster

# 1) Виртуальное окружение
py -3.11 -m venv .venv
./.venv/Scripts/Activate.ps1

# 2) Зависимости (вариант без requirements.txt)
pip install -U pip
pip install aiogram==3.* pyrogram==2.* SQLAlchemy==2.* psycopg2-binary apscheduler environs pytz

# 3) Настройте .env в корне (см. пример выше)

# 4) Запуск (вариант 1 — из папки src, чтобы совпали относительные пути к msg/ и *.session)
cd bot_interface/src
python main.py

# 4) Запуск (вариант 2 — из корня)
# python bot_interface/src/main.py
```


### Как создавать и редактировать рассылки
1) В Telegram выполните `/create_mailing` и следуйте шагам мастера:
   - имя пакета → появится папка `msg/<имя>`;
   - выбор юзербота;
   - список chat_id через запятую (можно `-100...` для каналов/супергрупп);
   - одно сообщение с текстом и/или фото (фото сохраняются в пакет);
   - выбор единицы периода и значения. Первая отправка планируется сразу.
2) Для правок — `/edit_mailing`: изменить текст, добавить/удалить фото, поменять период (`/done` завершает добавление фото).
3) При включённом режиме отладки — `/debug_mail` → «Тест рассылки» → выбрать нужную.


### Важные детали реализации
- При старте приложение инициализирует БД и создаёт таблицы (`Base.metadata.create_all`).
- Планировщик использует таймзону UTC и хранилище заданий в той же PostgreSQL, что и приложение.
- Для каналов/супергрупп дополнительно пробуются альтернативные ID с префиксом `-100`.
- Обработчики зависят от внедрения зависимостей через контекст диспетчера (`dp["..."]`), который наполняется в `main.py`.


### Известные ограничения и примечания
- `utils/subscription_check.py` ссылается на `config.Aprove_bot.channel` — такой раздел в текущей модели конфига отсутствует и модуль не используется.
- Пути к `msg/` и `.session` зависят от текущей рабочей директории процесса. Для стабильной работы запускайте из `bot_interface/src` или приведите пути к абсолютным.
- Авторизация Pyrogram потребует валидных `.session` файлов либо интерактивного входа. В безынтерактивной среде подготовьте сессии заранее.


### Лицензия
Проект распространяется «как есть». Лицензия не указана.


